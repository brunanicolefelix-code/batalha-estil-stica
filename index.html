<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batalha Estil√≠stica</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #e8d4b8;
            min-height: 100vh;
        }

        header {
            background: linear-gradient(180deg, #3d2817 0%, #2d1810 100%);
            border-bottom: 3px solid #8b7355;
            padding: 20px;
            text-align: center;
        }

        header h1 {
            font-size: 2em;
            color: #d4af37;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .login-screen {
            background: linear-gradient(135deg, #3d2817 0%, #2d1810 100%);
            border: 3px solid #8b7355;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            margin: 50px auto;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-screen h2 {
            color: #d4af37;
            margin-bottom: 30px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .login-form input {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #8b7355;
            color: #e8d4b8;
            padding: 12px;
            border-radius: 5px;
            font-family: 'Georgia', serif;
            font-size: 1em;
        }

        .login-form button {
            background: linear-gradient(135deg, #2d5016 0%, #1a3009 100%);
            color: #d4af37;
            border: 2px solid #d4af37;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
        }

        .login-form button:hover {
            background: linear-gradient(135deg, #3d6b1f 0%, #2a4812 100%);
        }

        .rooms-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .rooms-section.hidden {
            display: none;
        }

        .room-card {
            background: linear-gradient(135deg, #3d2817 0%, #2d1810 100%);
            border: 3px solid #8b7355;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .room-card h2 {
            color: #d4af37;
            margin-bottom: 10px;
        }

        .room-card button {
            background: linear-gradient(135deg, #d4af37 0%, #aa8c2c 100%);
            color: #1a1a1a;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .room-card button:hover {
            background: linear-gradient(135deg, #e8c547 0%, #c9a961 100%);
        }

        .game-area {
            display: none;
            background: linear-gradient(135deg, #3d2817 0%, #2d1810 100%);
            border: 3px solid #8b7355;
            border-radius: 10px;
            padding: 20px;
        }

        .game-area.active {
            display: block;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .game-header h2 {
            color: #d4af37;
        }

        .back-button {
            background: #8b4513;
            color: #e8d4b8;
            border: 2px solid #d4af37;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .back-button:hover {
            background: #a0522d;
        }

        .timer-section {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #8b7355;
            text-align: center;
            margin-bottom: 20px;
        }

        .timer-label {
            color: #c9a961;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .timer-display {
            font-size: 3em;
            color: #d4af37;
            font-weight: bold;
        }

        .sorteio-section {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #8b7355;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        .sorteio-section.show {
            display: block;
        }

        .sorteio-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .sorteio-item {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 5px;
            border: 2px solid #8b7355;
        }

        .sorteio-label {
            color: #c9a961;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .sorteio-valor {
            color: #d4af37;
            font-size: 1.8em;
            font-weight: bold;
        }

        .game-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-section {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #8b7355;
        }

        .input-section h3 {
            color: #d4af37;
            margin-bottom: 10px;
        }

        .input-section textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #8b7355;
            color: #e8d4b8;
            padding: 10px;
            border-radius: 5px;
            min-height: 100px;
            font-family: 'Georgia', serif;
            resize: vertical;
            font-size: 1em;
        }

        .input-section textarea:disabled {
            opacity: 0.5;
        }

        .submit-button {
            background: linear-gradient(135deg, #2d5016 0%, #1a3009 100%);
            color: #d4af37;
            border: 2px solid #d4af37;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            width: 100%;
            font-size: 1em;
        }

        .submit-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .players-section {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #8b7355;
        }

        .players-section h3 {
            color: #d4af37;
            margin-bottom: 10px;
        }

        .players-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .player-card {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #8b7355;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .player-name {
            color: #d4af37;
            font-weight: bold;
            margin-bottom: 5px;
            word-break: break-word;
            font-size: 0.9em;
        }

        .player-status {
            color: #c9a961;
            font-size: 0.85em;
        }

        .ranking-section {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #8b7355;
            grid-column: 1 / -1;
        }

        .ranking-section h3 {
            color: #d4af37;
            margin-bottom: 10px;
        }

        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }

        .ranking-table th {
            color: #d4af37;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #8b7355;
        }

        .ranking-table td {
            color: #e8d4b8;
            padding: 10px;
            border-bottom: 1px solid #8b7355;
        }

        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
        }

        .status-success {
            background: #2d5016;
            color: #7cfc00;
        }

        .status-error {
            background: #5a1a1a;
            color: #ff6b6b;
        }

        footer {
            background: linear-gradient(180deg, #2d1810 0%, #1a0f0a 100%);
            border-top: 3px solid #8b7355;
            padding: 20px;
            text-align: center;
            margin-top: 40px;
            color: #c9a961;
        }

        @media (max-width: 768px) {
            .game-content {
                grid-template-columns: 1fr;
            }
            .sorteio-display {
                grid-template-columns: 1fr;
            }
            .timer-display {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>‚öîÔ∏è Batalha Estil√≠stica ‚öîÔ∏è</h1>
    </header>

    <div class="container">
        <div id="loginScreen" class="login-screen">
            <h2>üè∞ Bem-vindo! üè∞</h2>
            <div class="login-form">
                <input type="text" id="playerNameInput" placeholder="Seu nome...">
                <button onclick="app.iniciarJogo()">Entrar</button>
            </div>
        </div>

        <div id="roomsSection" class="rooms-section hidden">
            <div style="grid-column: 1/-1; text-align: center; margin-bottom: 20px;">
                <h2 style="color: #d4af37;">üë§ <span id="playerNameDisplay"></span></h2>
            </div>
            <div class="room-card">
                <h2>üè∞ Sala 1</h2>
                <button onclick="app.enterRoom(1)">Entrar</button>
            </div>
            <div class="room-card">
                <h2>üóº Sala 2</h2>
                <button onclick="app.enterRoom(2)">Entrar</button>
            </div>
            <div class="room-card">
                <h2>üèØ Sala 3</h2>
                <button onclick="app.enterRoom(3)">Entrar</button>
            </div>
        </div>

        <div id="gameArea" class="game-area">
            <div class="game-header">
                <h2 id="roomTitle">Sala 1</h2>
                <span style="color: #d4af37;">üë§ <span id="gamePlayerInfo"></span></span>
                <button class="back-button" onclick="app.backToRooms()">Voltar</button>
            </div>

            <div class="timer-section">
                <div class="timer-label" id="timerLabel">Preparando...</div>
                <div class="timer-display" id="timerDisplay">10</div>
            </div>

            <div class="sorteio-section" id="sorteioSection">
                <h3>üìú Sorteado para esta rodada:</h3>
                <div class="sorteio-display">
                    <div class="sorteio-item">
                        <div class="sorteio-label">üìö Figura de Linguagem</div>
                        <div class="sorteio-valor" id="figuraSorteada">-</div>
                    </div>
                    <div class="sorteio-item">
                        <div class="sorteio-label">üìù Palavra</div>
                        <div class="sorteio-valor" id="palavraSorteada">-</div>
                    </div>
                </div>
            </div>

            <div class="game-content">
                <div class="input-section">
                    <h3>üñãÔ∏è Sua Frase:</h3>
                    <textarea id="fraseUsuario" placeholder="Escreva aqui..." disabled></textarea>
                    <button class="submit-button" id="submitBtn" onclick="app.enviarFrase()" disabled>Enviar</button>
                    <div id="statusMessage"></div>
                </div>

                <div class="players-section">
                    <h3>üë• Jogadores na Sala</h3>
                    <div class="players-list" id="playersList"></div>
                </div>
            </div>

            <div class="ranking-section">
                <h3>üèÜ Ranking da Sala</h3>
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>Posi√ß√£o</th>
                            <th>Jogador</th>
                            <th>Pontos</th>
                            <th>Frases Corretas</th>
                        </tr>
                    </thead>
                    <tbody id="rankingBody">
                        <tr>
                            <td colspan="4" style="text-align: center;">Aguardando jogadores...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <footer>
        Trabalho desenvolvido para a disciplina de Estil√≠stica do Texto - PUC Campinas
    </footer>

    <script>
        const app = {
            firebaseConfig: {
                apiKey: "AIzaSyB18wCa-yEhMYQkxY8ZlBoRIvBS1OAmjqg",
                authDomain: "estilistica.firebaseapp.com",
                databaseURL: "https://estilistica-default-rtdb.firebaseio.com",
                projectId: "estilistica",
                storageBucket: "estilistica.firebasestorage.app",
                messagingSenderId: "622934874774",
                appId: "1:622934874774:web:2ca073255bbf1b2d8f40b7"
            },
            
            figuras: ["Met√°fora", "Meton√≠mia", "Hip√©rbole", "Ironia", "Personifica√ß√£o", "Compara√ß√£o", "Ant√≠tese", "Alitera√ß√£o", "Onomatopeia", "Paradoxo", "Sinestesia", "Oximoro", "Eufemismo", "Litote", "Sin√©doque"],
            palavras: ["Amor", "Morte", "Vida", "Luz", "Escurid√£o", "Tempestade", "Oceano", "Montanha", "Floresta", "Rio", "Fogo", "Gelo", "Vento", "Chuva", "Sil√™ncio", "Grito", "M√∫sica", "Dan√ßa", "Sonho", "Realidade", "Esperan√ßa", "Medo", "Coragem", "Fraqueza", "Beleza", "Fealdade", "Verdade", "Mentira", "Justi√ßa", "Injusti√ßa", "Paz", "Guerra", "Liberdade", "Pris√£o", "Riqueza", "Pobreza"],
            
            playerName: '',
            playerId: '',
            currentRoom: null,
            gameTimer: null,
            updateTimer: null,
            roomRef: null,
            db: null,
            gameState: { fase: 'prep', inicio: Date.now(), categoria: null, palavra: null },

            init() {
                firebase.initializeApp(this.firebaseConfig);
                this.db = firebase.database();
            },

            iniciarJogo() {
                const inputName = document.getElementById('playerNameInput').value.trim();
                if (!inputName) {
                    alert('Digite seu nome!');
                    return;
                }
                
                this.playerName = inputName;
                this.playerId = 'p_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('roomsSection').classList.remove('hidden');
                document.getElementById('playerNameDisplay').textContent = this.playerName;
            },

            enterRoom(roomNumber) {
                this.currentRoom = roomNumber;
                this.roomRef = this.db.ref(`salas/sala_${roomNumber}`);
                
                document.getElementById('roomsSection').classList.add('hidden');
                document.getElementById('gameArea').classList.add('active');
                document.getElementById('roomTitle').textContent = `Sala ${roomNumber}`;
                document.getElementById('gamePlayerInfo').textContent = this.playerName;

                this.initializeRoom();
                this.startGameLoop();
                this.startUpdateLoop();
            },

            initializeRoom() {
                this.roomRef.child('jogadores').child(this.playerId).set({
                    nome: this.playerName,
                    pontos: 0,
                    frases_corretas: 0,
                    enviou: false
                });

                this.roomRef.child('estado').once('value', (snapshot) => {
                    if (snapshot.exists()) {
                        this.gameState = snapshot.val();
                    } else {
                        this.gameState = { fase: 'prep', inicio: Date.now(), categoria: null, palavra: null };
                        this.roomRef.child('estado').set(this.gameState);
                    }
                });
            },

            backToRooms() {
                if (this.gameTimer) clearInterval(this.gameTimer);
                if (this.updateTimer) clearInterval(this.updateTimer);
                
                this.roomRef.child('jogadores').child(this.playerId).remove();

                this.currentRoom = null;
                this.roomRef = null;
                document.getElementById('roomsSection').classList.remove('hidden');
                document.getElementById('gameArea').classList.remove('active');
                document.getElementById('fraseUsuario').value = '';
                document.getElementById('fraseUsuario').disabled = true;
                document.getElementById('submitBtn').disabled = true;
            },

            startGameLoop() {
                this.gameTimer = setInterval(() => {
                    if (!this.roomRef) return;
                    
                    this.roomRef.child('estado').once('value', (snapshot) => {
                        if (snapshot.exists()) {
                            this.gameState = snapshot.val();
                        }

                        const now = Date.now();
                        const elapsed = now - this.gameState.inicio;

                        if (this.gameState.fase === 'prep') {
                            if (elapsed < 10000) {
                                const secs = Math.ceil((10000 - elapsed) / 1000);
                                document.getElementById('timerLabel').textContent = 'Preparando...';
                                document.getElementById('timerDisplay').textContent = secs;
                                document.getElementById('fraseUsuario').disabled = true;
                                document.getElementById('submitBtn').disabled = true;
                                document.getElementById('sorteioSection').classList.remove('show');
                            } else {
                                const cat = this.figuras[Math.floor(Math.random() * this.figuras.length)];
                                const pal = this.palavras[Math.floor(Math.random() * this.palavras.length)];
                                this.gameState = { fase: 'escrita', inicio: now, categoria: cat, palavra: pal };
                                this.roomRef.child('estado').set(this.gameState);
                            }
                        } else if (this.gameState.fase === 'escrita') {
                            if (elapsed < 20000) {
                                const secs = Math.ceil((20000 - elapsed) / 1000);
                                document.getElementById('timerLabel').textContent = 'Tempo para escrever:';
                                document.getElementById('timerDisplay').textContent = secs;
                                document.getElementById('figuraSorteada').textContent = this.gameState.categoria || '-';
                                document.getElementById('palavraSorteada').textContent = this.gameState.palavra || '-';
                                document.getElementById('sorteioSection').classList.add('show');
                                document.getElementById('fraseUsuario').disabled = false;
                                document.getElementById('submitBtn').disabled = false;
                            } else {
                                document.getElementById('fraseUsuario').disabled = true;
                                document.getElementById('submitBtn').disabled = true;
                                document.getElementById('statusMessage').innerHTML = '<div class="status-message status-error">Tempo encerrado!</div>';
                                
                                setTimeout(() => {
                                    this.gameState = { fase: 'prep', inicio: Date.now(), categoria: null, palavra: null };
                                    this.roomRef.child('estado').set(this.gameState);
                                    document.getElementById('statusMessage').innerHTML = '';
                                    document.getElementById('fraseUsuario').value = '';
                                    
                                    this.roomRef.child('jogadores').once('value', (snap) => {
                                        if (snap.exists()) {
                                            snap.forEach((child) => {
                                                this.roomRef.child('jogadores').child(child.key).update({ enviou: false });
                                            });
                                        }
                                    });
                                }, 3000);
                            }
                        }
                    });
                }, 500);
            },

            startUpdateLoop() {
                this.updateTimer = setInterval(() => {
                    if (!this.roomRef) return;
                    
                    this.roomRef.child('jogadores').once('value', (snapshot) => {
                        if (snapshot.exists()) {
                            const jogadores = {};
                            snapshot.forEach((child) => {
                                jogadores[child.key] = child.val();
                            });
                            this.updatePlayers(jogadores);
                        }
                    });
                }, 1000);
            },

            updatePlayers(jogadores) {
                const list = document.getElementById('playersList');
                list.innerHTML = Object.values(jogadores).map(p => `
                    <div class="player-card">
                        <div class="player-name">${p.nome}</div>
                        <div class="player-status">${p.enviou ? '‚úì Enviou' : '‚è≥ Aguardando'}</div>
                        <div style="color: #d4af37; margin-top: 5px;">${p.pontos} pts</div>
                    </div>
                `).join('');
                this.updateRanking(jogadores);
            },

            updateRanking(jogadores) {
                const ranking = Object.values(jogadores).sort((a, b) => b.pontos - a.pontos);
                const tbody = document.getElementById('rankingBody');
                tbody.innerHTML = ranking.map((p, i) => `
                    <tr>
                        <td>#${i + 1}</td>
                        <td>${p.nome}</td>
                        <td>${p.pontos}</td>
                        <td>${p.frases_corretas}</td>
                    </tr>
                `).join('');
            },

            enviarFrase() {
                const frase = document.getElementById('fraseUsuario').value.trim();
                
                if (!frase) {
                    document.getElementById('statusMessage').innerHTML = '<div class="status-message status-error">Escreva uma frase!</div>';
                    return;
                }

                if (!this.gameState || !this.gameState.categoria) {
                    document.getElementById('statusMessage').innerHTML = '<div class="status-message status-error">Categoria n√£o carregada!</div>';
                    return;
                }

                const resultado = this.analisarFrase(frase, this.gameState.categoria);
                const pontos = resultado ? 10 : 0;

                this.roomRef.child('jogadores').child(this.playerId).update({
                    enviou: true,
                    pontos: firebase.database.ServerValue.increment(pontos),
                    frases_corretas: firebase.database.ServerValue.increment(resultado ? 1 : 0)
                });

                document.getElementById('fraseUsuario').disabled = true;
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('statusMessage').innerHTML = `<div class="status-message status-success">‚úì Enviado! ${pontos} pts</div>`;
            },

            analisarFrase(frase, figura) {
                const f = frase.toLowerCase();
                const palavrasArray = frase.split(/\s+/).filter(p => p.length > 2);

                if (frase.length < 10 || palavrasArray.length < 5) return false;

                switch(figura) {
                    case "Met√°fora": return /\b√©\b/.test(f);
                    case "Meton√≠mia": return /\b(l√™|bebe|assiste|ouve|come)\b/.test(f);
                    case "Hip√©rbole": return /\b(milh√µes|infinito|eternidade|nunca|sempre)\b/.test(f);
                    case "Ironia": return /\b(claro|√≥bvio|l√≥gico)\b/.test(f);
                    case "Personifica√ß√£o": return /\b(dan√ßa|canta|chora|sorri|respira)\b/.test(f);
                    case "Compara√ß√£o": return /\bcomo\b/.test(f);
                    case "Ant√≠tese": return /\b(mas|por√©m|contudo)\b/.test(f);
                    default: return palavrasArray.length >= 5;
                }
            }
        };

        app.init();
    </script>
</body>
</html>
